# Custom Chat Widget API Documentation

This documentation outlines how to integrate a custom chat interface with Morpheus Desk. This allows you to build your own UI while leveraging our ticketing and AI capabilities.

## Base URL

All REST API requests should be made to:
`https://api.morpheusdesk.com/api/webhooks`

For local development:
`http://localhost:3000/api/webhooks`

## Authentication

Authentication is handled via your **Organization ID** (found in your dashboard). You must include this ID in every request.

- **Header**: `x-channel-id: <YOUR_ORG_ID>`
- **Query/Body Parameter**: `channelId`

---

## 1. Send a Message

Send a message from a user to the helpdesk. If the user doesn't exist, they will be automatically created using the provided name and email.

**Endpoint:** `POST /api/webhooks/widget`

### Headers

| Header         | Value              |
| -------------- | ------------------ |
| `Content-Type` | `application/json` |
| `x-channel-id` | `<YOUR_ORG_ID>`    |

### Body Parameters

| Parameter     | Type   | Required | Description                                                                                                                  |
| ------------- | ------ | -------- | ---------------------------------------------------------------------------------------------------------------------------- |
| `content`     | string | Yes      | The message text to send.                                                                                                    |
| `sessionId`   | string | Yes      | A unique, stable ID for the user (e.g., your app's User ID). This ensures chat history is preserved across devices/sessions. |
| `name`        | string | No       | The user's full name.                                                                                                        |
| `email`       | string | No       | The user's email address. Used to link the chat to a Customer profile.                                                       |
| `attachments` | array  | No       | Array of file attachment objects (if supported).                                                                             |
| `tempId`      | string | No       | A temporary ID generated by your frontend to track the message before receiving a server ID.                                 |

### Example Request

```json
// POST /api/webhooks/widget
{
  "content": "Hi, I'm having trouble with my subscription.",
  "sessionId": "user_id_550e8400",
  "name": "Sarah Connor",
  "email": "sarah@example.com"
}
```

### Response

```json
{
  "success": true,
  "ticketId": "65b2...",
  "messageId": "65b2..."
}
```

---

## 2. Upload a File

Upload a file (image, document, etc.) before sending a message. This returns an attachment object that you should include in the `attachments` array when calling **Send a Message**.

**Endpoint:** `POST /api/webhooks/widget/upload`

### Headers

| Header         | Value                 |
| -------------- | --------------------- |
| `Content-Type` | `multipart/form-data` |
| `x-channel-id` | `<YOUR_ORG_ID>`       |

### Form Data Parameters

| Parameter   | Type   | Required | Description                                     |
| ----------- | ------ | -------- | ----------------------------------------------- |
| `file`      | file   | Yes      | The file to upload.                             |
| `channelId` | string | No       | Your Organization ID (if not passed in header). |

### Response

```json
{
  "success": true,
  "attachment": {
    "id": "65b2...",
    "filename": "1706798000000-image.png",
    "originalName": "image.png",
    "mimeType": "image/png",
    "size": 1024,
    "url": "https://..."
  }
}
```

### Example Curl

```bash
curl -X POST "http://localhost:3000/api/webhooks/widget/upload" \\
     -H "x-channel-id: 69724acec84f3520beda873c" \\
     -F "file=@/path/to/your/image.png"
```

---

## 3. Get Chat History

Retrieve the conversation history for a specific user session.

**Endpoint:** `GET /api/webhooks/widget/history`

### Query Parameters

| Parameter   | Required | Description                                      |
| ----------- | -------- | ------------------------------------------------ |
| `channelId` | Yes      | Your Organization ID.                            |
| `sessionId` | Yes      | The unique session/user ID to fetch history for. |

### Example Request

`GET /api/webhooks/widget/history?channelId=org_123&sessionId=user_id_550e8400`

### Response

```json
{
  "messages": [
    {
      "id": "msg_101",
      "text": "Hi, I'm having trouble with my subscription.",
      "sender": "user",
      "timestamp": 1706798000000
    },
    {
      "id": "msg_102",
      "text": "Hello Sarah! I can help with that. What seems to be the issue?",
      "sender": "agent",
      "authorName": "Support AI",
      "timestamp": 1706798050000
    }
  ]
}
```

---

## 4. Get Widget Configuration

Retrieve the configured branding and settings for your organization (e.g., colors, welcome message). Use this if you want your custom UI to match the settings defined in the Morpheus dashboard.

**Endpoint:** `GET /api/webhooks/widget/config`

### Query Parameters

| Parameter   | Required | Description           |
| ----------- | -------- | --------------------- |
| `channelId` | Yes      | Your Organization ID. |

### Example Request

`GET /api/webhooks/widget/config?channelId=org_123`

### Response

```json
{
  "primaryColor": "#06B6D4",
  "secondaryColor": "#0F2035",
  "welcomeMessage": "Hello! How can we help you today?",
  "headerText": "Chat with us",
  "position": "bottom-right"
}
```

---

## 5. Real-time Updates (WebSocket)

Instead of polling `GET /history`, you can connect via WebSocket to receive messages in real-time.

**Connection URL:** `wss://api.morpheusdesk.com/api/widget`
(For local: `ws://localhost:3000/api/widget`)

**Protocol:** Native WebSocket (not Socket.IO)

### Connection Options

Connect using a standard WebSocket client. Pass `channelId` and `sessionId` in the query parameters.

Query Parameters:

- `channelId` (Required)
- `sessionId` (Required)
- `name` (Optional - for first time identification)
- `email` (Optional - for first time identification)

```javascript
const socket = new WebSocket(
  'wss://api.morpheusdesk.com/widget?channelId=YOUR_ORG_ID&sessionId=user_session_abc123',
);

socket.onopen = () => {
  console.log('Connected to chat');
};

socket.onmessage = (event) => {
  const payload = JSON.parse(event.data);

  if (payload.event === 'message') {
    console.log('New message received:', payload.data);
    // data: { id: "...", text: "...", sender: "...", ... }
  } else if (payload.event === 'messageAck') {
    console.log('Message sent confirmed:', payload.data);
  }
};
```

### Sending Messages

To send a message, send a JSON string with the `event` type "message".

```javascript
// Send a message
const message = {
  event: 'message',
  data: {
    content: 'Hello, I need help!',
    tempId: 'msg_temp_123', // Optional, for matching acks
    attachments: [], // Optional
  },
};

socket.send(JSON.stringify(message));
```
